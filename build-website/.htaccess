#######################################################
## OTIMIZAÇÃO DE PERFORMANCE (CACHING E COMPRESSÃO) ##
#######################################################

# 1. Ativa o Rewrite Engine (Necessário para redirecionamentos)
RewriteEngine On

# 1.1 Desliga ETag (Reduz a sobrecarga do servidor, já que usamos mod_expires)
Header unset ETag
FileETag None

# 2. Compressão Gzip (Redução de tamanho dos arquivos)
<IfModule mod_deflate.c>
    # Tipos de arquivos a serem comprimidos (altamente recomendado para performance)
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# 3. Caching de Arquivos Estáticos (Browser Caching)
# Instruções para o navegador guardar arquivos por mais tempo
<IfModule mod_expires.c>
    ExpiresActive On

    # Configuração de Cache
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType font/ttf "access plus 1 month"
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
    ExpiresByType video/mp4 "access plus 1 month"

    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType application/x-javascript "access plus 1 week"

    ExpiresByType text/html "access plus 1 hour"
</IfModule>

#######################################################
## REGRAS DE SEGURANÇA E REDIRECIONAMENTO    ##
#######################################################

# 4 & 5. Redirecionamento Combinado (www para não-www E HTTP para HTTPS)
# CORREÇÃO: Usa X-Forwarded-Proto para funcionar com Cloudflare
RewriteCond %{HTTP:X-Forwarded-Proto} !https [NC,OR]
RewriteCond %{HTTP_HOST} ^www\.phasscode\.com$ [NC]
RewriteRule ^(.*)$ https://phasscode.com/$1 [L,R=301]

# 6. Desativa a listagem de diretórios (Segurança)
Options -Indexes

# 7. Páginas de Erro Personalizadas
ErrorDocument 500 /500.html
ErrorDocument 404 /404.html
ErrorDocument 403 /403.html

# 8. Headers de Segurança Adicionais
<IfModule mod_headers.c>
    # Header de Segurança HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS

    # Impedir Clickjacking
    Header always set X-Frame-Options SAMEORIGIN

    # Proteção contra XSS
    Header always set X-XSS-Protection "1; mode=block"

    # Evitar que o navegador tente 'adivinhar' o tipo de conteúdo (segurança)
    Header always set X-Content-Type-Options nosniff

    # Controle de política de conteúdo (Ajuste se carregar muitos recursos externos)
    # Header always set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';"
</IfModule>

# 9. Define o arquivo padrão para diretórios
DirectoryIndex index.html index.php /index.html